---
title: "predictR"
author: "Wesley Chioh"
date: "April 19, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# setting up shop 
library(tidyverse)
library(ggplot2)
library(eia)
library(fredr)
library(zoo)
library(plotly)
library(caret)
library(gbm)
library(doParallel)
library(stargazer)
set.seed(1728)

# load API key
eia_api_key <- readtext::readtext("eia_api_key.txt") %>%
  .$text
fred_api_key <- readtext::readtext("fred_api_key.txt") %>%
  .$text
eia_set_key(eia_api_key)
fredr_set_key(fred_api_key)

# load datasets
electricity <- read_csv("monthly_electricity.csv")
rigs <- read_csv("monthly_rigs_count.csv")
gdp <- readxl::read_excel("Monthly GDP for Project.xlsx")
business_sentiment <- read_csv("business_tendencies.csv")
## pct labor force unemloyed for more than 15 weeks
LT_unemployed <- fredr(series_id = "U1RATE", observation_start = as.Date("1973-01-01"))
## yield curve 10year minue 3month
yield_curve <- fredr(series_id = "T10Y3M", observation_start=as.Date('1947-01-01'))
```

## Data Processing  

Relevant time scale: Monthly  
Datasets: Electricity generation, Rigs count, GDP, OECD Business Tendency Survey, Percentage of Civilian Workforce Unemployed >15 weeks  
  

```{r data wrangling}
gdp_complete <- gdp %>%
  mutate(date = as.yearmon(substr((Date), 1, 7)),
         `GDP (Continuously Compounding)` = `GDP (Continuously Compounding)`*100,
         `GDP (YoY % Change)` = `GDP (YoY % Change)`*100, 
         gdp_change_lagged = lag(`GDP (Continuously Compounding)`, 1)) %>%
  filter(date >= "Jan 1973") %>%
  select(date, `GDP (YoY % Change)`, `GDP (Continuously Compounding)`, gdp_change_lagged)
electricity_complete <- electricity %>%
  mutate(date = as.yearmon(date),
         rate_generated_change = (value - lag(value,1))/lag(value,1),
         rate_generated_change_secondorder = (rate_generated_change - lag(rate_generated_change,1))/lag(rate_generated_change,1)) %>%
  select(date, rate_generated_change, rate_generated_change_secondorder) 
rigs_complete <- rigs %>%
  mutate(date = as.yearmon(substr(date, 1, 7))) %>%
  select(date, change_first_order, change_second_order)
colnames(rigs_complete)[2:3] <- c("rigs_change_first_order", "rigs_change_second_order")
business_sentiment <- business_sentiment %>%
  mutate(date = as.yearmon(substr(date, 1, 7)),
         sentiment_change_first_order = (value - lag(value,1))/lag(value,1)) %>%
  select(date, value, distance_peak, sentiment_change_first_order)
colnames(business_sentiment)[2] <- "business_sentiment"
sentiment_period <- rep(0, dim(business_sentiment)[1])
for (i in 2:dim(business_sentiment)[1]){
  sentiment_i = business_sentiment$sentiment_change_first_order[i]
  #print(sentiment_i)
  sentiment_h = business_sentiment$sentiment_change_first_order[i-1]
  #print(sentiment_h)
  sentiment_h[is.na(sentiment_h)] <- 0
  if(sign(sentiment_i) == sign(sentiment_h)){
    sentiment_period[i] = sentiment_period[i-1]+1
  }
  else{
    sentiment_period[i] = 1
  }
}
business_sentiment$sentiment_period <- sentiment_period

LT_unemployed_complete <- LT_unemployed %>%
  mutate(date = as.yearmon(substr(date, 1, 7)),
         rate_change_first_order = (value - lag(value,1))/lag(value,1)) %>%
  select(date, value, rate_change_first_order)
colnames(LT_unemployed_complete)[2] <- "LT_unemployment"
rate_change_period <- rep(0, dim(LT_unemployed_complete)[1])
threshold_period <- rep(0, dim(LT_unemployed_complete)[1])
for (i in 2:dim(LT_unemployed_complete)[1]){
  sentiment_i = LT_unemployed_complete$rate_change_first_order[i]
  #print(sentiment_i)
  sentiment_h = LT_unemployed_complete$rate_change_first_order[i-1]
  #print(sentiment_h)
  sentiment_h[is.na(sentiment_h)] <- 0
  if(sign(sentiment_i) == sign(sentiment_h)|sign(sentiment_i)==0){
    rate_change_period[i] = rate_change_period[i-1]+1
  }
  else{
   rate_change_period[i] = 1
  }
  if(LT_unemployed_complete$LT_unemployment[i] <= 1.5){
    threshold_period[i] = threshold_period[i-1]+1
  }
}
LT_unemployed_complete$threshold_period <- threshold_period
LT_unemployed_complete$rate_change_period <- rate_change_period

yield_curve[is.na(yield_curve)] <- 0
yield_curve <- yield_curve %>%
  drop_na() %>%
  mutate(date = as.yearmon(substr(date, 1, 7)),
         value = ifelse(value < 0, -1, 1)) %>%
  group_by(date) %>%
  summarise(value = min(value)) %>%
  mutate(value = as.factor(value))
colnames(yield_curve)[2] <- "curve"

# inner join all together and to get recession dates
econ_situation_nber_df <- inner_join(gdp_complete, electricity_complete, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, rigs_complete, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, business_sentiment, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, LT_unemployed_complete, by = "date")
NBER_recession_months <- econ_situation_nber_df$date %>%
  .[c(11:27, 85:90, 103:119, 211:219, 339:347, 420:438)]
econ_situation_nber_df <- inner_join(econ_situation_nber_df, yield_curve, by = "date")
econ_situation_nber_df <- econ_situation_nber_df %>%
  mutate(NBER_recession = ifelse(date %in% NBER_recession_months, "Y", "N"),
         NBER_recession_next = as.factor(lead(NBER_recession,1)),
         NBER_recession_two = as.factor(lead(NBER_recession,2))
         ) %>%
  as.data.frame() %>%
  drop_na()

DT::datatable(econ_situation_nber_df)
```

## Modeling Proper  
  
Throwing in all of the variables to test for omitted variable bias. 

```{r probit eval = FALSE, echo = FALSE}
econ_situation_nber_df2 <- econ_situation_nber_df %>%
  select(gdp_change_lagged:rate_change_period, NBER_recession_next)
econ_situation_nber_df2[is.na(econ_situation_nber_df2)] <- 0
econ_situation_nber_df2_iv <- econ_situation_nber_df2[,1:13]
comboinfo <- findLinearCombos(econ_situation_nber_df2_iv)
# inspecting the linear combo info, it appears that there are no linearly dependent variables 
descrCor <- cor(econ_situation_nber_df2_iv)
# inspecting  the correlation matrix, it appears that distance_peak is perfectly correlated with business sentiment so that should be removed
econ_situation_nber_df2 <- econ_situation_nber_df2[,-7]
recession_probit <- glm(NBER_recession_next ~., family = binomial(link = "probit"), data = econ_situation_nber_df)
summary(recession_probit)
```




```{r random_forest two month, fig.height=8, fig.width=8}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(4:17)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(4:17)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 101
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
# cl <- makePSOCKcluster(5)
# registerDoParallel(cl)
# rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid, ntree = ntrees)
# stopCluster(cl)
# saveRDS(rf_recession, "./models/rf_2mth_all.RDS")
rf_recession <- readRDS("./models/rf_2mth_all.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
predict_y_prob <- predict(rf_recession,newdata = test_x, "prob")
predict_y_prob$date <- econ_situation_nber_df$date[-testIDs]
predict_y_prob$actual <- test_y
predict_y_prob$predicted <- predict_y
cm_2mth_all <- confusionMatrix(predict_y, reference = test_y)
saveRDS(cm_2mth_all, "./models/confusion_matrix_2mth_all.RDS")
cm_2mth_all$byClass

prob_model_2 <- ggplotly(ggplot(predict_y_prob, aes(x = date, y = Y)) +
                         geom_point(aes(color = actual)) + 
                         geom_hline(yintercept = 0.50) + 
                         labs(y = "Probability", x = "Date", colour = "NBER", 
                              title = "Probability of a Recession 2 Months Ahead", subtitle = "Probabilistic Prediction of a Random Forest Model"))
saveRDS(prob_model_2, "./models/ggplot_prob_model_2.RDS")
prob_model_2
```

```{r random forest onemonth}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(4:17)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(4:17)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 101
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid, ntree = ntrees)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_1mth_all.RDS")
rf_recession <- readRDS("./models/rf_1mth_all.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
predict_y_prob <- predict(rf_recession,newdata = test_x, "prob")
predict_y_prob$date <- econ_situation_nber_df$date[-testIDs]
predict_y_prob$actual <- test_y
predict_y_prob$predicted <- predict_y
cm_1mth_all <- confusionMatrix(predict_y, reference = test_y)
saveRDS(cm_1mth_all, "./models/confusion_matrix_1mth_all.RDS")
cm_1mth_all$overall

prob_model <- ggplotly(ggplot(predict_y_prob, aes(x = date, y = Y)) +
                         geom_point(aes(color = actual)) + 
                         geom_hline(yintercept = 0.50) + 
                         labs(y = "Probability", x = "Date", colour = "NBER", 
                              title = "Probability of a Recession a Month Ahead", subtitle = "Probabilistic Prediction of a Random Forest Model"))
saveRDS(prob_model, "./models/ggplot_prob_model.RDS")
prob_model
```

```{r plotting random forest}

tree_func <- function(final_model, 
                      tree_num) {
  
  # get tree by index
  tree <- randomForest::getTree(final_model, 
                                k = tree_num, 
                                labelVar = TRUE) %>%
    tibble::rownames_to_column() %>%
    # make leaf split points to NA, so the 0s won't get plotted
    mutate(`split point` = ifelse(is.na(prediction), `split point`, NA))
  
  # prepare data frame for graph
  graph_frame <- data.frame(from = rep(tree$rowname, 2),
                            to = c(tree$`left daughter`, tree$`right daughter`))
  
  # convert to graph and delete the last node that we don't want to plot
  graph <- graph_from_data_frame(graph_frame) %>%
    delete_vertices("0")
  
  # set node labels
  V(graph)$node_label <- gsub("_", " ", as.character(tree$`split var`))
  V(graph)$leaf_label <- as.character(tree$prediction)
  V(graph)$split <- as.character(round(tree$`split point`, digits = 2))
  
  # plot
  plot <- ggraph(graph, 'dendrogram') + 
    theme_bw() +
    geom_edge_link() +
    geom_node_point() +
    geom_node_text(aes(label = node_label), na.rm = TRUE, repel = TRUE) +
    geom_node_label(aes(label = split), vjust = 2.5, na.rm = TRUE, fill = "white") +
    geom_node_label(aes(label = leaf_label, fill = leaf_label), na.rm = TRUE, 
					repel = TRUE, colour = "white", fontface = "bold", show.legend = FALSE) +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_blank(),
          panel.background = element_blank(),
          plot.background = element_rect(fill = "white"),
          panel.border = element_blank(),
          axis.line = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          plot.title = element_text(size = 18))
  
  print(plot)
}

tree_num <- which(rf_recession$finalModel$forest$ndbigtree == min(rf_recession$finalModel$forest$ndbigtree))
tree_plot <- tree_func(final_model = rf_recession$finalModel, 12)
saveRDS(tree_plot, "./models/tree_plot.RDS")
```



## Models

So I created multiple random forest and stochastic gradient boosting models and asked them a very simple question: Will there be a recession the following month or not, given the data?  
The model was trained and tested on a 70:30 randomly sampled split. 
  
How to read a confusion matrix? The diagonal running from top-left to bottom-right is the number of correct predictions. No Information Rate means that if the model just predicted `Y` all the time, it would get it right how many % of the time.  

### Random Forest and Stochastic Gradient Boosting 1A1  
These model does  **NOT** include GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 1A1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(5:16)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(5:16)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_1mth_woGDP.RDS")
rf_recession <- readRDS("./models/rf_1mth_woGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 1A1}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(rate_generated_change:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                      number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# # gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_1mth_woGDP.RDS")
gbm_recession <- readRDS("./models/gbm_1mth_woGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```
  
### Random Forest and Stochastic Gradient Boosting 1A2  
These models does  **NOT** include GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.
```{r random_forest 1A2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(5:16)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(5:16)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_2mth_woGDP.RDS")
rf_recession <- readRDS("./models/rf_2mth_woGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```

```{r gbm 1A2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(rate_generated_change:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                    number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# # gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_2mth_woGDP.RDS")
gbm_recession <- readRDS("./models/gbm_2mth_woGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
```  
### Random Forest and Stochastic Gradient Boosting 1B1  
These models include the present month's GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 1B1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(2, 5:16)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(2, 5:16)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_1mth_wGDP.RDS")
rf_recession <- readRDS("./models/rf_1mth_wGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```

```{r gbm 1B1}
set.seed(1995)
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`GDP (YoY % Change)` ,rate_generated_change:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
testing_time <- econ_situation_nber_df$date[-testIDs]
# model tuning 
 trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
#saveRDS(gbm_recession, "./models/gbm_1mth_wGDP.RDS")
#gbm_recession <- readRDS("./models/gbm_1mth_wGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```

### Random Forest and Stochastic Gradient Boosting 1B2  
These models includes the present month's GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 1B2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(2, 5:16)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(2, 5:16)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_2mth_wGDP.RDS")
rf_recession <- readRDS("./models/rf_2mth_wGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 1B2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`GDP (YoY % Change)` ,rate_generated_change:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# # gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_2mth_wGDP.RDS")
gbm_recession <- readRDS("./models/gbm_2mth_wGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
```  
  
### Random Forest and Stochastic Gradient Boosting 1C1  
This model includes the previous month's GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 1C1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(4:16)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(4:16)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
# cl <- makePSOCKcluster(5)
# registerDoParallel(cl)
# rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
# stopCluster(cl)
# saveRDS(rf_recession, "./models/rf_1mth_wGDP_lagged.RDS")
rf_recession <- readRDS("./models/rf_1mth_wGDP_lagged.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 1C1}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(gdp_change_lagged:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_1mth_wGDP_lagged.RDS")
gbm_recession <- readRDS("./models/gbm_1mth_wGDP_lagged.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```  
  
### Random Forest 1C2  
This model includes the previous month's GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 1C2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(4:16)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(4:16)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/rf_2mth_wGDP_lagged.RDS")
rf_recession <- readRDS("./models/rf_2mth_wGDP_lagged.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 1C2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(gdp_change_lagged:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                      number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_2mth_wGDP_lagged.RDS")
gbm_recession <- readRDS("./models/gbm_2mth_wGDP_lagged.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
```  
  
### With Shorter Dataset

```{r data wrangling 2}
gdp_complete <- gdp %>%
  mutate(date = as.yearmon(substr((Date), 1, 7)),
         `GDP (Continuously Compounding)` = `GDP (Continuously Compounding)`*100,
         `GDP (YoY % Change)` = `GDP (YoY % Change)`*100, 
         gdp_change_lagged = lag(`GDP (Continuously Compounding)`, 1)) %>%
  drop_na() %>%
  select(date, gdp_change_lagged, `GDP (YoY % Change)`, `GDP (Continuously Compounding)`, `Probability of Losing a Job`)

# inner join all together and to get recession dates
econ_situation_nber_df <- inner_join(gdp_complete, electricity_complete, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, rigs_complete, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, business_sentiment, by = "date")
econ_situation_nber_df <- inner_join(econ_situation_nber_df, LT_unemployed_complete, by = "date")
NBER_recession_months <- econ_situation_nber_df$date %>%
  .[c(11:27, 85:90, 103:119, 211:219, 339:347, 420:438)]
econ_situation_nber_df <- econ_situation_nber_df %>%
  mutate(NBER_recession = ifelse(date %in% NBER_recession_months, "Y", "N"),
         NBER_recession_next = as.factor(lead(NBER_recession,1)),
         NBER_recession_two = as.factor(lead(NBER_recession, 2))) %>%
  as.data.frame() %>%
  drop_na()

#DT::datatable(econ_situation_nber_df)
```

### Random Forest and Stochastic Gradient Boosting 2A1  
These model does  **NOT** include GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 2A1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(5:17)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(5:17)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_1mth_woGDP.RDS")
rf_recession <- readRDS("./models/jolts_rf_1mth_woGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 2A1}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`Probability of Losing a Job`:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/jolts_gbm_1mth_woGDP.RDS")
gbm_recession <- readRDS("./models/jolts_gbm_1mth_woGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```
  
### Random Forest and Stochastic Gradient Boosting 1A2  
These models does  **NOT** include GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.
```{r random_forest 2A2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(5:17)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(5:17)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# following can be commented out if loading a pretrained model from file 
# parallel processing to speed things up
# random forest model 
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_2mth_woGDP.RDS")
rf_recession <- readRDS("./models/jolts_rf_2mth_woGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```

```{r gbm 2A2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`Probability of Losing a Job`:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                  number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/jolts_gbm_2mth_woGDP.RDS")
gbm_recession <- readRDS("./models/jolts_gbm_2mth_woGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
```  
### Random Forest and Stochastic Gradient Boosting 2B1  
These models include the present month's GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 2B1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(3, 5:17)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(3, 5:17)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_1mth_wGDP.RDS")
rf_recession <- readRDS("./models/jolts_rf_1mth_wGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```

```{r gbm 2B1}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`GDP (YoY % Change)` ,`Probability of Losing a Job`:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
## gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
saveRDS(gbm_recession, "./models/jolts_gbm_1mth_wGDP.RDS")
stopCluster(cl)
gbm_recession <- readRDS("./models/jolts_gbm_1mth_wGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```

### Random Forest and Stochastic Gradient Boosting 2B2  
These models includes the present month's GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 2B2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(2, 4:17)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(2, 4:17)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_2mth_wGDP.RDS")
rf_recession <- readRDS("./models/jolts_rf_2mth_wGDP.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 2B2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`GDP (YoY % Change)` ,`Probability of Losing a Job`:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
#gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/gbm_2mth_wGDP.RDS")
gbm_recession <- readRDS("./models/gbm_2mth_wGDP.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
```  
  
### Random Forest and Stochastic Gradient Boosting 2C1  
This model includes the previous month's GDP growth data. It is a one-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 2C1}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(2, 5:17)]
train_y <- econ_situation_nber_df$NBER_recession_next[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(2, 5:17)]
test_y <- econ_situation_nber_df$NBER_recession_next[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_1mth_wGDP_lagged.RDS")
rf_recession <- readRDS("./models/jolts_rf_1mth_wGDP_lagged.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 2C1}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(gdp_change_lagged, `Probability of Losing a Job`:rate_change_period, NBER_recession_next)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_next, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                     number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
##gbm model 
gbm_recession <- train(NBER_recession_next~., data = training,  method = "gbm", trControl = trctrl)
saveRDS(gbm_recession, "./models/jolts_gbm_1mth_wGDP_lagged.RDS")
stopCluster(cl)
gbm_recession <- readRDS("./models/jolts_gbm_1mth_wGDP_lagged.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_next)
```  
  
### Random Forest and Stochastic Gradient Boosting 2C2  
These models includes the previous month's GDP growth data. It is a two-month forecast of whether the economy will be in a recession as defined by NBER.  

```{r random_forest 2C2}
# creating test-train data
testIDs <- createDataPartition(econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
train_x <- econ_situation_nber_df[testIDs,c(2, 5:17)]
train_y <- econ_situation_nber_df$NBER_recession_two[testIDs]
test_x <- econ_situation_nber_df[-testIDs, c(2, 5:17)]
test_y <- econ_situation_nber_df$NBER_recession_two[-testIDs] 

# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5, search = "grid")
mtry <- ncol(train_x)
ntrees <- 71
tunegrid <- expand.grid(.mtry = c(2:mtry))
metric = "Accuracy"
# random forest model 
# enable parallel processing
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
rf_recession <- train(x = train_x, y = train_y, method = "rf", metric = metric, trControl = trctrl, tuneGrid = tunegrid)
stopCluster(cl)
saveRDS(rf_recession, "./models/jolts_rf_2mth_wGDP_lagged.RDS")
rf_recession <- readRDS("./models/jolts_rf_2mth_wGDP_lagged.RDS")
predict_y <- predict(rf_recession, newdata = test_x)
confusionMatrix(predict_y, reference = test_y)
```
  
```{r gbm 2C2}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(gdp_change_lagged, `Probability of Losing a Job`:rate_change_period, NBER_recession_two)
testIDs <- createDataPartition(final_econ_situation_nber_df$NBER_recession_two, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                      number = 10, repeats = 10)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(NBER_recession_two~., data = training,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/jolts_gbm_2mth_wGDP_lagged.RDS")
gbm_recession <- readRDS("./models/jolts_gbm_2mth_wGDP_lagged.RDS") 
predict_y_prob <- predict(gbm_recession, newdata = testing, type = "prob")
predict_y_factor <- predict(gbm_recession, newdata = testing)
confusionMatrix(predict_y_factor, reference = testing$NBER_recession_two)
``` 


### Stochastic Gradient Boosting 3  
This model predicts the expected GDP change. 
```{r gbm 3}
final_econ_situation_nber_df <- econ_situation_nber_df %>%
  select(`GDP (YoY % Change)`,`Probability of Losing a Job`:rate_change_period)
testIDs <- createDataPartition(final_econ_situation_nber_df$`GDP (YoY % Change)`, p = 0.7, list = F)
training <- final_econ_situation_nber_df[testIDs,]
bootstrapIDs <- createResample(training$`GDP (YoY % Change)`, list = F)
training_bootstrapped <- training[bootstrapIDs,]
testing <- final_econ_situation_nber_df[-testIDs,]
# model tuning 
trctrl <- trainControl(method = "repeatedcv", 
                       number = 10, repeats = 5)
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
# gbm model 
gbm_recession <- train(`GDP (YoY % Change)`~., data = training_bootstrapped,  method = "gbm", trControl = trctrl)
stopCluster(cl)
saveRDS(gbm_recession, "./models/jolts_gbm_GDPChange.RDS")
gbm_recession <- readRDS("./models/jolts_gbm_GDPChange.RDS") 
y_predict <- predict(gbm_recession, newdata = testing)
testing$gdp_predict <- y_predict
ggplot(testing, aes(x = `GDP (YoY % Change)`, y = gdp_predict)) + 
  geom_point() + 
  geom_abline(slope = 1)
postResample(y_predict, obs = testing$`GDP (YoY % Change)`)
```


